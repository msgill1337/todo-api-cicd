trigger:
  branches:
    include:
      - main
      - Dev

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: todo-api-variables
  - name: buildNumber
    value: '$(Build.BuildNumber)'
  - name: imageName
    value: 'todo-api'
  - name: dockerConnectionName
    value: 'acr-connection'
  - name: k8sServiceConnection
    value: 'aks-connection'

stages:
  # ========================================
  # STAGE 1: BUILD
  # ========================================
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Docker Image'
        steps:      
          - checkout: self         
          - task: Docker@2
            displayName: 'Build Docker Image'
            inputs:
                command: 'build'
                Dockerfile: 'Dockerfile'
                repository: '$(imageName)'
                tags: '$(Build.BuildId)'
          - script: |
              docker run -d --name test-container $(imageName):$(Build.BuildId)
              sleep 5
              docker exec test-container npm test
              docker stop test-container
              docker rm test-container
            displayName: 'Run Unit Tests'
            continueOnError: false

          - script: |
              # Install and run Trivy
              # Scan for vulnerabilities

              sudo apt-get update
              sudo apt-get install wget apt-transport-https gnupg lsb-release -y
              wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
              echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
              sudo apt-get update
              sudo apt-get install trivy -y

              echo "Scanning image for vulnerabilities..."
              # Scan and save report
              trivy image --format table --output trivy-report.txt $(imageName):$(Build.BuildId)

              cat trivy-report.txt

              trivy image --exit-code 1 --severity CRITICAL $(imageName):$(Build.BuildId)
            displayName: 'Security Scan with Trivy'
            continueOnError: false

          - script: |
                docker tag $(imageName):$(Build.BuildId) $(ACR_LOGIN_SERVER)/$(imageName):$(Build.BuildId)
            displayName: 'Tagging the image before push'

          - task: Docker@2
            displayName: 'Push to ACR'
            inputs:
              command: 'push'
              containerRegistry: '$(dockerConnectionName)'
              repository: '$(imageName)'
              tags: '$(Build.BuildId)'


  # ========================================
  # STAGE 2: DEPLOY TO DEV
  # ========================================
  - stage: DeployDev
    displayName: 'Deploy to Dev'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployDevJob
        displayName: 'Deploy to Dev Environment'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    ls -la

                    sed -i 's|#{ACR_NAME}#\.azurecr\.io/todo-api:#{BUILD_NUMBER}#|$(ACR_LOGIN_SERVER)/todo-api:$(Build.BuildId)|g' k8s/deployment.yaml
                    sed -i 's|#{ENVIRONMENT}#|dev|g' k8s/deployment.yaml
                    sed -i 's|#{BUILD_NUMBER}#|$(Build.BuildId)|g' k8s/deployment.yaml
                  displayName: 'Replace tokens in manifests'
                

                - task: Kubernetes@1
                  displayName: 'Deploy new app to AKS Dev'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: '$(k8sServiceConnection)'
                    namespace: 'todo-dev'
                    command: 'apply'
                    arguments: '-f k8s/deployment.yaml'

                - task: Kubernetes@1
                  displayName: 'Deploy services to AKS Dev'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: '$(k8sServiceConnection)'
                    namespace: 'todo-dev'
                    command: 'apply'
                    arguments: '-f k8s/service.yaml'

                - task: Kubernetes@1
                  displayName: 'Setup kubectl context'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: '$(k8sServiceConnection)'
                    namespace: 'dev'
                    command: 'login'

                - script: |
                    echo "Running smoke tests against deployed app in dev namespace..."
                    
                    # Wait for deployment to be ready
                    kubectl wait --for=condition=available --timeout=120s deployment/todo-api -n todo-dev
                    
                    # Get the service external IP (LoadBalancer)
                    SERVICE_IP=$(kubectl get svc todo-api -n todo-dev -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                    echo "Service IP: $SERVICE_IP"
                    
                    # Wait for LoadBalancer IP to be assigned
                    RETRY_COUNT=0
                    MAX_RETRIES=30
                    while [ -z "$SERVICE_IP" ] && [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                      echo "Waiting for LoadBalancer IP... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                      sleep 10
                      SERVICE_IP=$(kubectl get svc todo-api -n todo-dev -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                      RETRY_COUNT=$((RETRY_COUNT + 1))
                    done
                    
                    if [ -z "$SERVICE_IP" ]; then
                      echo "Failed to get LoadBalancer IP after $MAX_RETRIES attempts"
                      exit 1
                    fi
                    
                    echo "Testing health endpoint at http://$SERVICE_IP/health"
                    
                    # Test health endpoint
                    HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://$SERVICE_IP/health)
                    
                    if [ "$HEALTH_RESPONSE" = "200" ]; then
                      echo "‚úÖ Health check passed!"
                      curl -s http://$SERVICE_IP/health | jq '.'
                    else
                      echo "‚ùå Health check failed with status: $HEALTH_RESPONSE"
                      exit 1
                    fi
                    
                    # Test API endpoint
                    echo "Testing API endpoint at http://$SERVICE_IP/api/todos"
                    API_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://$SERVICE_IP/api/todos)
                    
                    if [ "$API_RESPONSE" = "200" ]; then
                      echo "‚úÖ API check passed!"
                      curl -s http://$SERVICE_IP/api/todos | jq '.'
                    else
                      echo "‚ùå API check failed with status: $API_RESPONSE"
                      exit 1
                    fi
                    
                    echo "‚úÖ All smoke tests passed!"
                  displayName: 'Smoke Tests'
                  continueOnError: false

  # ========================================
  # STAGE 3: DEPLOY TO STAGING
  # ========================================
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: DeployDev
    condition: succeeded()
    jobs:
      - deployment: DeployStagingJob
        displayName: 'Deploy to Staging Environment'
        environment: 'staging' 
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    sed -i 's|#{ACR_NAME}#\.azurecr\.io/todo-api:#{BUILD_NUMBER}#|$(ACR_LOGIN_SERVER)/todo-api:$(Build.BuildId)|g' k8s/deployment.yaml
                    sed -i 's|#{ENVIRONMENT}#|staging|g' k8s/deployment.yaml
                    sed -i 's|#{BUILD_NUMBER}#|$(Build.BuildId)|g' k8s/deployment.yaml
                  displayName: 'Replace tokens in manifests'
                

                - task: Kubernetes@1
                  displayName: 'Deploy app to AKS Staging'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: '$(k8sServiceConnection)'
                    namespace: 'todo-staging'
                    command: 'apply'
                    arguments: '-f k8s/deployment.yaml'

                - task: Kubernetes@1
                  displayName: 'Deploy services to AKS Staging'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: '$(k8sServiceConnection)'
                    namespace: 'todo-staging'
                    command: 'apply'
                    arguments: '-f k8s/service.yaml'

                - task: Kubernetes@1
                  displayName: 'Setup kubectl context'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: '$(k8sServiceConnection)'
                    namespace: 'dev'
                    command: 'login'
      
                - script: |
                    echo "Running smoke tests against deployed app in staging namespace..."
                    
                    # Wait for deployment to be ready
                    kubectl wait --for=condition=available --timeout=120s deployment/todo-api -n todo-staging
                    
                    # Get the service external IP (LoadBalancer)
                    SERVICE_IP=$(kubectl get svc todo-api -n todo-staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                    echo "Service IP: $SERVICE_IP"
                    
                    # Wait for LoadBalancer IP to be assigned
                    RETRY_COUNT=0
                    MAX_RETRIES=30
                    while [ -z "$SERVICE_IP" ] && [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                      echo "Waiting for LoadBalancer IP... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                      sleep 10
                      SERVICE_IP=$(kubectl get svc todo-api -n todo-staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                      RETRY_COUNT=$((RETRY_COUNT + 1))
                    done
                    
                    if [ -z "$SERVICE_IP" ]; then
                      echo "Failed to get LoadBalancer IP after $MAX_RETRIES attempts"
                      exit 1
                    fi
                    
                    echo "Testing health endpoint at http://$SERVICE_IP/health"
                    
                    # Test health endpoint
                    HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://$SERVICE_IP/health)
                    
                    if [ "$HEALTH_RESPONSE" = "200" ]; then
                      echo "‚úÖ Health check passed!"
                      curl -s http://$SERVICE_IP/health | jq '.'
                    else
                      echo "‚ùå Health check failed with status: $HEALTH_RESPONSE"
                      exit 1
                    fi
                    
                    # Test API endpoint
                    echo "Testing API endpoint at http://$SERVICE_IP/api/todos"
                    API_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://$SERVICE_IP/api/todos)
                    
                    if [ "$API_RESPONSE" = "200" ]; then
                      echo "‚úÖ API check passed!"
                      curl -s http://$SERVICE_IP/api/todos | jq '.'
                    else
                      echo "‚ùå API check failed with status: $API_RESPONSE"
                      exit 1
                    fi
                    
                    echo "‚úÖ All smoke tests passed!"
                  displayName: 'Smoke Tests'
                  env: 
                    KUBECONFIG: $(System.DefaultWorkingDirectory)/kubeconfig
                  continueOnError: false

  # ========================================
  # STAGE 4: DEPLOY TO PROD
  # ========================================
  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: succeeded()
    jobs:
      - deployment: DeployProdJob
        displayName: 'Deploy to Production Environment'
        environment: 'production' 
        strategy:
          runOnce:
            deploy:
              steps:

                - script: echo "Deploy to production"
                - checkout: self             
                - task: Kubernetes@1
                  displayName: 'Setup kubectl context'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: '$(k8sServiceConnection)'
                    namespace: 'dev'
                    command: 'login'
      
                - script: |
                    echo "Testing blue/green deployment before switching traffic..."
                    
                    # Check if service exists (first deployment)
                    if ! kubectl get svc todo-api-service -n todo-prod &>/dev/null; then
                      echo "üÜï First deployment detected - setting up blue-green infrastructure..."
                      
                      # Replace tokens in prod deployment manifests
                      sed -i 's|#{ACR_NAME}#\.azurecr\.io/todo-api:#{BUILD_NUMBER}#|$(ACR_LOGIN_SERVER)/todo-api:$(Build.BuildId)|g' k8s/prod-deployment.yaml
                      sed -i 's|#{ENVIRONMENT}#|production|g' k8s/prod-deployment.yaml
                      sed -i 's|#{BUILD_NUMBER}#|$(Build.BuildId)|g' k8s/prod-deployment.yaml
                      
                      # Deploy blue-green infrastructure
                      kubectl apply -f k8s/prod-deployment.yaml -n todo-prod
                      
                      # Wait for blue deployment to be ready
                      kubectl rollout status deployment/todo-api-blue -n todo-prod --timeout=5m
                      
                      echo "‚úÖ Initial blue-green setup complete! Blue is active."
                      exit 0
                    fi
                    
                    # Get the active slot 
                    SLOT=$(kubectl get svc todo-api-service -n todo-prod -o jsonpath='{.spec.selector.version}')
                    echo "Active slot: $SLOT"
                    
                    # Determine the OTHER slot
                    if [ "$SLOT" = "blue" ]; then
                      OTHER_SLOT="green"
                    else
                      OTHER_SLOT="blue"
                    fi
                    
                    echo "üöÄ Deploying to $OTHER_SLOT..."

                    # Check if deployment exists, if not create it
                    if ! kubectl get deployment todo-api-$OTHER_SLOT -n todo-prod &>/dev/null; then
                      echo "Creating $OTHER_SLOT deployment..."
                      # Replace tokens and create deployment
                      sed -i 's|#{ACR_NAME}#\.azurecr\.io/todo-api:#{BUILD_NUMBER}#|$(ACR_LOGIN_SERVER)/todo-api:$(Build.BuildId)|g' k8s/prod-deployment.yaml
                      sed -i 's|#{ENVIRONMENT}#|production|g' k8s/prod-deployment.yaml
                      sed -i 's|#{BUILD_NUMBER}#|$(Build.BuildId)|g' k8s/prod-deployment.yaml
                      kubectl apply -f k8s/prod-deployment.yaml -n todo-prod
                    else
                      kubectl set image deployment/todo-api-$OTHER_SLOT -n todo-prod \
                        todo-api=$(ACR_LOGIN_SERVER)/todo-api:$(Build.BuildId) --record
                    fi

                    echo "üìà Scaling up $OTHER_SLOT"

                    kubectl scale deployment/todo-api-$OTHER_SLOT -n todo-prod --replicas=2

                    echo "‚è≥ Waiting for rollout..."

                    kubectl rollout status deployment/todo-api-$OTHER_SLOT -n todo-prod --timeout=5m

                    echo "üß™ Running smoke tests..."

                    POD=$(kubectl get pods -n todo-prod -l app=todo-api,version=$OTHER_SLOT -o jsonpath='{.items[0].metadata.name}')

                    kubectl port-forward -n todo-prod $POD 8080:3000 &
                    PF_PID=$!
                    sleep 20

                    curl -f http://localhost:8080/health || { kill $PF_PID; exit 1; }
                    kill $PF_PID

                    echo "üîÑ Switching traffic to $OTHER_SLOT..."
                    kubectl patch service todo-api-service -n todo-prod \
                      -p "{\"spec\":{\"selector\":{\"version\":\"$OTHER_SLOT\"}}}"

                    echo "‚úÖ Deployment complete! Traffic now on $OTHER_SLOT"
                    
                    echo "‚ÑπÔ∏è  Old version ($SLOT) being scaled down"

                    kubectl scale deployment/todo-api-$SLOT -n todo-prod --replicas=0

                  displayName: 'Check and switch'
                  continueOnError: false