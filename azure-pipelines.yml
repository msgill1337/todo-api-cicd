trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: todo-api-variables  # You'll create this
  - name: buildNumber
    value: '$(Build.BuildNumber)'
  - name: acrName
    value: 'YOUR_ACR_NAME'  # Replace with your ACR name
  - name: imageName
    value: 'todo-api'

stages:
  # ========================================
  # STAGE 1: BUILD
  # ========================================
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Docker Image'
        steps:
          # YOUR TASK: Checkout code
          - checkout: self

          # YOUR TASK: Build Docker image
          - task: Docker@2
            displayName: 'Build Docker Image'
            inputs:
              # Fill in the Docker task parameters
              # Hint: command, repository, dockerfile, tags

          # YOUR TASK: Run unit tests
          - script: |
              # Run tests here
              # Hint: docker run with test command
            displayName: 'Run Unit Tests'

          # YOUR TASK: Scan image with Trivy
          - script: |
              # Install and run Trivy
              # Scan for vulnerabilities
            displayName: 'Security Scan with Trivy'

          # YOUR TASK: Push image to ACR
          - task: Docker@2
            displayName: 'Push to ACR'
            inputs:
              # Fill in push parameters

  # ========================================
  # STAGE 2: DEPLOY TO DEV
  # ========================================
  - stage: DeployDev
    displayName: 'Deploy to Dev'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployDevJob
        displayName: 'Deploy to Dev Environment'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                # YOUR TASK: Replace tokens in K8s manifests
                - task: replacetokens@5
                  displayName: 'Replace tokens in manifests'
                  inputs:
                    # Configure token replacement

                # YOUR TASK: Deploy to AKS dev namespace
                - task: Kubernetes@1
                  displayName: 'Deploy to AKS Dev'
                  inputs:
                    # Configure kubectl deployment

                # YOUR TASK: Run smoke tests
                - script: |
                    # Test the deployed service
                  displayName: 'Smoke Tests'

  # ========================================
  # STAGE 3: DEPLOY TO STAGING
  # ========================================
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: DeployDev
    condition: succeeded()
    jobs:
      - deployment: DeployStagingJob
        displayName: 'Deploy to Staging Environment'
        environment: 'staging'  # Manual approval configured here
        strategy:
          runOnce:
            deploy:
              steps:
                # YOUR TASK: Similar to dev, but staging namespace
                - script: echo "Deploy to staging"

  # ========================================
  # STAGE 4: DEPLOY TO PROD
  # ========================================
  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: succeeded()
    jobs:
      - deployment: DeployProdJob
        displayName: 'Deploy to Production Environment'
        environment: 'production'  # Manual approval required
        strategy:
          runOnce:
            deploy:
              steps:
                # YOUR TASK: Production deployment
                # Consider blue-green deployment here
                - script: echo "Deploy to production"